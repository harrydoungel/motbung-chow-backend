<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Delivery Partner - Motbung Chow</title>
  
  <!-- INCLUDE THE SHARED NOTIFICATION SYSTEM -->
  <script src="js/notification.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Arial', sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    
    /* UPDATED: Header with Profile on LEFT */
    header {
      background: white;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      position: relative;
    }
    
    .header-top {
      display: flex;
      align-items: flex-start;
      gap: 20px;
      margin-bottom: 0;
      flex-wrap: wrap;
    }
    
    /* DELIVERY PROFILE SECTION - Now on LEFT */
    .delivery-profile {
      position: relative;
      text-align: center;
      flex-shrink: 0;
      margin-top: 5px; /* Added to align with logo */
    }
    
    /* Bigger Profile Icon */
    .profile-icon {
      width: 80px;
      height: 80px;
      background: #667eea;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      font-weight: bold;
      cursor: pointer;
      margin: 0 auto 5px auto;
      border: 4px solid white;
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      transition: all 0.3s ease;
    }
    
    .profile-icon:hover {
      background: #5a67d8;
      transform: scale(1.05);
    }
    
    .profile-name {
      font-weight: bold;
      color: #333;
      cursor: pointer;
      font-size: 14px;
      text-align: center;
      padding: 4px 10px;
      background: rgba(102, 126, 234, 0.1);
      border-radius: 12px;
      display: inline-block;
      max-width: 120px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* Logo section adjusted to make room for profile */
    .logo-section {
      flex-grow: 1;
      margin-top: -5px; /* Move logo section up */
    }
    
    .logo {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
      margin-left: 10px; /* Adjusted for profile space */
      margin-bottom: 5px; /* Space for subheading */
    }
    
    .logo span {
      color: #667eea;
    }
    
    /* NEW: Subheading style */
    .subheading {
      font-size: 14px;
      color: #666;
      margin-left: 40px; /* Align with the logo text (accounting for the emoji) */
      font-style: italic;
      margin-top: -2px; /* Bring it closer to the main title */
    }
    
    /* Profile Dropdown - Adjusted position */
    .profile-dropdown {
      position: absolute;
      top: 90px;
      left: 0;
      background: white;
      border-radius: 10px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
      width: 300px;
      z-index: 1000;
      display: none;
      padding: 20px;
      text-align: left;
    }
    
    .profile-dropdown.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* DELIVERY PERSON SECTION REMOVED FROM HEADER */
    /* This section has been removed as per your request */
    
    .profile-info {
      margin-bottom: 20px;
    }
    
    .profile-info h3 {
      margin-top: 0;
      color: #667eea;
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 10px;
      margin-bottom: 15px;
      font-size: 18px;
    }
    
    .info-item {
      margin: 12px 0;
      display: flex;
      align-items: center;
    }
    
    .info-item label {
      font-weight: bold;
      width: 100px;
      color: #555;
      font-size: 13px;
    }
    
    .info-item span {
      flex-grow: 1;
      color: #333;
      font-size: 14px;
      word-break: break-word;
    }
    
    .info-item input {
      flex-grow: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      background: #f8f9fa;
    }
    
    .profile-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }
    
    /* Overlay for dropdown */
    .dropdown-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.3);
      z-index: 999;
      display: none;
    }
    
    .dropdown-overlay.active {
      display: block;
    }
    
    /* Added status indicator */
    .status-indicator {
      margin-top: 5px;
      font-size: 12px;
      color: #4caf50;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }
    
    .status-indicator span {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: #4caf50;
      border-radius: 50%;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      transition: transform 0.3s;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
    }
    
    .stat-card i {
      font-size: 24px;
      margin-bottom: 10px;
      display: block;
    }
    
    .stat-card .number {
      font-size: 28px;
      font-weight: bold;
      color: #667eea;
      margin: 10px 0;
    }
    
    .stat-card .label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .orders-container {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .section-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .section-title h2 {
      color: #333;
      font-size: 20px;
    }
    
    .refresh-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
    }
    
    .refresh-btn:hover {
      background: #5a67d8;
    }
    
    .order-card {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 15px;
      border-left: 4px solid;
      transition: all 0.3s;
    }
    
    .order-card:hover {
      transform: translateX(5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .order-card.pending {
      border-left-color: #ff9800;
    }
    
    .order-card.assigned {
      border-left-color: #2196f3;
    }
    
    .order-card.delivered {
      border-left-color: #4caf50;
    }
    
    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .order-id {
      font-weight: bold;
      color: #333;
      font-size: 16px;
    }
    
    .order-status {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      background: #e0e0e0;
      color: #333;
    }
    
    .order-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .detail-item {
      margin-bottom: 8px;
    }
    
    .detail-item strong {
      color: #666;
      display: block;
      font-size: 12px;
      margin-bottom: 3px;
    }
    
    .detail-item span {
      color: #333;
      font-size: 14px;
    }
    
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover {
      background: #5a67d8;
    }
    
    .btn-success {
      background: #4caf50;
      color: white;
    }
    
    .btn-success:hover {
      background: #388e3c;
    }
    
    .btn-danger {
      background: #f44336;
      color: white;
    }
    
    .btn-danger:hover {
      background: #d32f2f;
    }
    
    .btn-edit {
      background: #2196f3;
      padding: 6px 12px;
      font-size: 13px;
    }
    
    .btn-edit:hover {
      background: #1976d2;
    }
    
    .btn-secondary {
      background: #666;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #555;
    }
    
    .map-link {
      background: #34c759;
      color: white;
      text-decoration: none;
      padding: 10px 15px;
      border-radius: 6px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      font-size: 14px;
    }
    
    .map-link:hover {
      background: #2daa4e;
    }
    
    .no-orders {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .no-orders i {
      font-size: 48px;
      margin-bottom: 20px;
      color: #ccc;
      display: block;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    }
    
    .modal-header {
      margin-bottom: 20px;
    }
    
    .modal-body {
      margin-bottom: 20px;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    /* Mobile Responsive */
    @media (max-width: 600px) {
      .header-top {
        flex-direction: column;
        gap: 15px;
      }
      
      .delivery-profile {
        width: 100%;
        order: 1;
      }
      
      .logo-section {
        order: 2;
        width: 100%;
        text-align: center;
        margin-top: 0;
      }
      
      .logo {
        justify-content: center;
        margin-left: 0;
      }
      
      .subheading {
        margin-left: 0;
        text-align: center;
      }
      
      .profile-dropdown {
        left: 50%;
        transform: translateX(-50%);
        width: 90vw;
        max-width: 300px;
      }
      
      .stats {
        grid-template-columns: 1fr 1fr;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
        justify-content: center;
      }
    }
    
    /* Icon styles */
    i {
      font-style: normal;
    }
    
    .icon-bike { display: inline-block; }
    .icon-money { display: inline-block; }
    .icon-time { display: inline-block; }
    .icon-star { display: inline-block; }
    
    /* Notification Styles */
    .notification-bell {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #ff4444;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
      z-index: 999;
      box-shadow: 0 4px 12px rgba(255, 68, 68, 0.4);
      animation: bellRing 0.5s ease 2;
    }
    
    @keyframes bellRing {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(-15deg); }
      75% { transform: rotate(15deg); }
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    
    /* Add this new pulse animation */
    @keyframes pulseScale {
      0% { transform: scale(1); box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4); }
      50% { transform: scale(1.1); box-shadow: 0 6px 20px rgba(255, 152, 0, 0.6); }
      100% { transform: scale(1); box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4); }
    }
  </style>
</head>
<body>
<!-- Profile Overlay -->
<div class="dropdown-overlay" id="profileOverlay"></div>

<!-- Audio Unlock Button (hidden by default) -->
<button id="audioUnlockBtn" style="
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #4CAF50;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 20px;
    cursor: pointer;
    z-index: 10002;
    display: none;
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
    font-weight: bold;
" onclick="unlockAudioNow()">
    üîä Enable Sounds
</button>
  
  <div class="container">
    <!-- UPDATED: Header with Profile on LEFT side -->
    <header>
      <div class="header-top">
        <!-- DELIVERY PROFILE - Now on LEFT side -->
        <div class="delivery-profile">
          <div class="profile-icon" onclick="toggleProfile()">
            DP
          </div>
          <div class="profile-name" onclick="toggleProfile()">
            Delivery Partner
          </div>
          <div class="status-indicator">
            <span></span> Online
          </div>
          
          <!-- Profile Dropdown -->
          <div class="profile-dropdown" id="profileDropdown">
            <div class="profile-info">
              <h3>Delivery Partner Profile</h3>
              
              <div class="info-item">
                <label>Name:</label>
                <span id="deliveryNameDisplay">Delivery Partner</span>
                <input type="text" id="deliveryNameInput" style="display:none;" value="Delivery Partner">
              </div>
              
              <div class="info-item">
                <label>Phone:</label>
                <span id="deliveryPhoneDisplay">+91 98765 43210</span>
                <input type="tel" id="deliveryPhoneInput" style="display:none;" value="+91 98765 43210">
              </div>
              
              <div class="info-item">
                <label>Address:</label>
                <span id="deliveryAddressDisplay">Imphal, Manipur</span>
                <input type="text" id="deliveryAddressInput" style="display:none;" value="Imphal, Manipur">
              </div>
              
              <div class="info-item">
                <label>Vehicle:</label>
                <span id="deliveryVehicleDisplay">Motorcycle</span>
                <input type="text" id="deliveryVehicleInput" style="display:none;" value="Motorcycle">
              </div>
              
              <div class="info-item">
                <label>Status:</label>
                <span style="color: #4caf50; font-weight: bold;">‚óè Online</span>
              </div>
            </div>
            
            <div class="profile-buttons">
              <button id="editProfileBtn" class="btn-edit" onclick="enableProfileEdit()">‚úèÔ∏è Edit</button>
              <button id="saveProfileBtn" class="btn-secondary" onclick="saveProfile()" style="display:none;">üíæ Save</button>
              <button class="btn-secondary" onclick="toggleProfile()">‚úï Close</button>
            </div>
          </div>
        </div>
        
        <!-- Logo Section - Moved up and with subheading -->
        <div class="logo-section">
          <div class="logo">
            <span>üöö</span> Motbung Chow Delivery
          </div>
          <!-- NEW: Subheading added -->
          <div class="subheading">North-East food delivery in Munirka</div>
        </div>
      </div>
    </header>
    
    <div class="stats">
      <div class="stat-card">
        <i>üì¶</i>
        <div class="number" id="totalOrders">0</div>
        <div class="label">Total Orders</div>
      </div>
      <div class="stat-card">
        <i>‚è≥</i>
        <div class="number" id="pendingOrders">0</div>
        <div class="label">Pending</div>
      </div>
      <div class="stat-card">
        <i>üí∞</i>
        <div class="number">‚Çπ<span id="totalEarnings">0</span></div>
        <div class="label">Today's Earnings</div>
      </div>
      <div class="stat-card">
        <i>‚≠ê</i>
        <div class="number" id="rating">4.8</div>
        <div class="label">Rating</div>
      </div>
    </div>
    
    <div class="orders-container">
      <div class="section-title">
        <h2>üìç Active Delivery Orders</h2>
        <button class="refresh-btn" onclick="loadDeliveryOrders()">
          üîÑ Refresh
        </button>
      </div>
      
      <div id="ordersList">
        <!-- Orders will be loaded here -->
      </div>
    </div>
  </div>
  
  <!-- Modal for Order Details -->
  <div class="modal" id="orderModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Order Details</h3>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Order details will be loaded here -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" onclick="closeModal()">Close</button>
        <button class="btn btn-success" onclick="startDelivery()">Start Delivery</button>
      </div>
    </div>
  </div>
  
  <script>
    const API_BASE_URL = "http://localhost:5001/api";
    let currentOrderId = null;
    
    // ================= DELIVERY PROFILE MANAGEMENT =================
    let isProfileEditing = false;
    let originalProfileValues = {};
    
    function toggleProfile() {
      const dropdown = document.getElementById('profileDropdown');
      const overlay = document.getElementById('profileOverlay');
      
      dropdown.classList.toggle('active');
      overlay.classList.toggle('active');
      
      // Close edit mode if open
      if (isProfileEditing) {
        cancelProfileEdit();
      }
    }
    
    function enableProfileEdit() {
      isProfileEditing = true;
      
      // Store original values
      originalProfileValues = {
        name: document.getElementById('deliveryNameDisplay').textContent,
        phone: document.getElementById('deliveryPhoneDisplay').textContent,
        address: document.getElementById('deliveryAddressDisplay').textContent,
        vehicle: document.getElementById('deliveryVehicleDisplay').textContent
      };
      
      // Hide spans, show inputs
      document.getElementById('deliveryNameDisplay').style.display = 'none';
      document.getElementById('deliveryNameInput').style.display = 'block';
      
      document.getElementById('deliveryPhoneDisplay').style.display = 'none';
      document.getElementById('deliveryPhoneInput').style.display = 'block';
      
      document.getElementById('deliveryAddressDisplay').style.display = 'none';
      document.getElementById('deliveryAddressInput').style.display = 'block';
      
      document.getElementById('deliveryVehicleDisplay').style.display = 'none';
      document.getElementById('deliveryVehicleInput').style.display = 'block';
      
      // Show save button, hide edit button
      document.getElementById('editProfileBtn').style.display = 'none';
      document.getElementById('saveProfileBtn').style.display = 'inline-block';
    }
    
    function cancelProfileEdit() {
      if (!isProfileEditing) return;
      
      // Restore original values
      document.getElementById('deliveryNameDisplay').textContent = originalProfileValues.name;
      document.getElementById('deliveryPhoneDisplay').textContent = originalProfileValues.phone;
      document.getElementById('deliveryAddressDisplay').textContent = originalProfileValues.address;
      document.getElementById('deliveryVehicleDisplay').textContent = originalProfileValues.vehicle;
      
      finishProfileEdit();
    }
    
    function finishProfileEdit() {
      // Hide inputs, show spans
      document.getElementById('deliveryNameDisplay').style.display = 'inline';
      document.getElementById('deliveryNameInput').style.display = 'none';
      
      document.getElementById('deliveryPhoneDisplay').style.display = 'inline';
      document.getElementById('deliveryPhoneInput').style.display = 'none';
      
      document.getElementById('deliveryAddressDisplay').style.display = 'inline';
      document.getElementById('deliveryAddressInput').style.display = 'none';
      
      document.getElementById('deliveryVehicleDisplay').style.display = 'inline';
      document.getElementById('deliveryVehicleInput').style.display = 'none';
      
      // Show edit button, hide save button
      document.getElementById('editProfileBtn').style.display = 'inline-block';
      document.getElementById('saveProfileBtn').style.display = 'none';
      
      isProfileEditing = false;
    }
    
    function saveProfile() {
      // Get values from inputs
      const newName = document.getElementById('deliveryNameInput').value;
      const newPhone = document.getElementById('deliveryPhoneInput').value;
      const newAddress = document.getElementById('deliveryAddressInput').value;
      const newVehicle = document.getElementById('deliveryVehicleInput').value;
      
      // Update display values
      document.getElementById('deliveryNameDisplay').textContent = newName;
      document.getElementById('deliveryPhoneDisplay').textContent = newPhone;
      document.getElementById('deliveryAddressDisplay').textContent = newAddress;
      document.getElementById('deliveryVehicleDisplay').textContent = newVehicle;
      
      // Update profile name in header
      document.querySelector('.profile-name').textContent = newName;
      
      // Update profile icon with first letter
      document.querySelector('.profile-icon').textContent = newName.charAt(0).toUpperCase();
      
      // Save to localStorage
      localStorage.setItem('deliveryProfile', JSON.stringify({
        name: newName,
        phone: newPhone,
        address: newAddress,
        vehicle: newVehicle
      }));
      
      // Finish edit mode
      finishProfileEdit();
      
      // Show success message
      alert('‚úÖ Profile saved successfully!');
    }
    
    // Load saved profile on page load
    function loadSavedProfile() {
      const saved = localStorage.getItem('deliveryProfile');
      if (saved) {
        const profile = JSON.parse(saved);
        
        document.getElementById('deliveryNameDisplay').textContent = profile.name;
        document.getElementById('deliveryNameInput').value = profile.name;
        
        document.getElementById('deliveryPhoneDisplay').textContent = profile.phone;
        document.getElementById('deliveryPhoneInput').value = profile.phone;
        
        document.getElementById('deliveryAddressDisplay').textContent = profile.address;
        document.getElementById('deliveryAddressInput').value = profile.address;
        
        document.getElementById('deliveryVehicleDisplay').textContent = profile.vehicle;
        document.getElementById('deliveryVehicleInput').value = profile.vehicle;
        
        // Update UI elements
        document.querySelector('.profile-name').textContent = profile.name;
        document.querySelector('.profile-icon').textContent = profile.name.charAt(0).toUpperCase();
      }
    }
    
    // Close dropdown when clicking overlay
    document.getElementById('profileOverlay').addEventListener('click', function() {
      toggleProfile();
    });
    
    // Close dropdown with Escape key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        const dropdown = document.getElementById('profileDropdown');
        if (dropdown.classList.contains('active')) {
          if (isProfileEditing) {
            cancelProfileEdit();
          }
          toggleProfile();
        }
      }
    });
    
    // ================= DELIVERY SYSTEM =================
    
    // Login check for delivery partner
    document.addEventListener("DOMContentLoaded", () => {
      loadSavedProfile(); // Load saved profile
      
      const deliveryToken = localStorage.getItem("deliveryToken");
      if (!deliveryToken) {
        const password = prompt("Enter Delivery Partner Password:");
        if (password === "delivery123") { // Simple password for demo
          localStorage.setItem("deliveryToken", "delivery_auth_token");
          loadDeliveryOrders();
        } else {
          alert("Access denied");
          window.location.href = "index.html";
        }
      } else {
        loadDeliveryOrders();
      }
      
      // Auto-refresh orders every 30 seconds
      setInterval(loadDeliveryOrders, 30000);
    });
    
    function unlockAudioNow() {
      if (window.NotificationSystem && window.NotificationSystem.unlockAudio) {
          NotificationSystem.unlockAudio().then(unlocked => {
              if (unlocked) {
                  document.getElementById('audioUnlockBtn').style.display = 'none';
                  alert('‚úÖ Sound notifications enabled!');
              }
          });
      }
    }
    
    // Show unlock button if audio is blocked
    setTimeout(() => {
      const btn = document.getElementById('audioUnlockBtn');
      if (btn) {
        setTimeout(() => {
          btn.style.display = 'block';
        }, 3000);
      }
    }, 1000);
    
    // Load delivery orders
    async function loadDeliveryOrders() {
      try {
        const res = await fetch(`${API_BASE_URL}/orders`);
        const data = await res.json();
        
        if (!data.success) {
          throw new Error("Failed to fetch orders");
        }
        
        const orders = data.orders || [];
        updateStats(orders);
        displayOrders(orders);
      } catch (error) {
        console.error("Error loading orders:", error);
        document.getElementById("ordersList").innerHTML = `
          <div class="no-orders">
            <div>üì°</div>
            <p>Failed to load orders. Check server connection.</p>
          </div>
        `;
      }
    }
    
    // Update statistics
    function updateStats(orders) {
      const pendingOrders = orders.filter(o => 
        o.status === "PENDING" || o.status === "COD_PENDING"
      ).length;
      
      const today = new Date().toDateString();
      const todayOrders = orders.filter(o => 
        new Date(o.createdAt).toDateString() === today
      );
      
      const todayEarnings = todayOrders.length * 20; // ‚Çπ20 per delivery
      
      document.getElementById("totalOrders").textContent = todayOrders.length;
      document.getElementById("pendingOrders").textContent = pendingOrders;
      document.getElementById("totalEarnings").textContent = todayEarnings;
    }
    
    // Display orders for delivery
    function displayOrders(orders) {
      const container = document.getElementById("ordersList");
      
      // Filter only pending orders (not delivered)
      const pendingOrders = orders.filter(o => 
        o.status !== "DELIVERED"
      );
      
      if (pendingOrders.length === 0) {
        container.innerHTML = `
          <div class="no-orders">
            <div>üì≠</div>
            <p>No active delivery orders</p>
            <p style="font-size: 12px; margin-top: 10px;">New orders will appear here automatically</p>
          </div>
        `;
        return;
      }
      
      let html = '';
      
      pendingOrders.forEach(order => {
        // Determine order status and class
        let statusClass = "pending";
        let statusText = order.status;
        let statusColor = "#ff9800";
        
        if (order.status === "PAID") {
          statusClass = "assigned";
          statusText = "Ready for Delivery";
          statusColor = "#2196f3";
        } else if (order.status === "COD_PENDING") {
          statusClass = "pending";
          statusText = "COD - Awaiting";
          statusColor = "#ff9800";
        }
        
        // Check if location has coordinates
        const hasCoords = order.location && (
          order.location.includes("Lat:") && 
          order.location.includes("Lng:")
        );
        
        // Extract coordinates
        let mapLink = "";
        if (order.mapLink) {
          mapLink = order.mapLink;
        } else if (hasCoords) {
          const coordsMatch = order.location.match(/Lat:\s*([\d.]+),\s*Lng:\s*([\d.]+)/);
          if (coordsMatch) {
            mapLink = `https://www.google.com/maps?q=${coordsMatch[1]},${coordsMatch[2]}`;
          }
        }
        
        // Format time
        const orderTime = new Date(order.createdAt);
        const timeAgo = getTimeAgo(orderTime);
        
        html += `
          <div class="order-card ${statusClass}" data-order-id="${order.orderId}">
            <div class="order-header">
              <div class="order-id">Order #${order.orderId}</div>
              <div class="order-status" style="background: ${statusColor};">${statusText}</div>
            </div>
            
            <div class="order-details">
              <div class="detail-item">
                <strong>Amount</strong>
                <span>‚Çπ${order.amount} ${order.paymentMethod === "COD" ? "(Cash on Delivery)" : "(Paid Online)"}</span>
              </div>
              
              <div class="detail-item">
                <strong>Customer Location</strong>
                <span style="color: ${hasCoords ? '#4caf50' : '#666'}">
                  ${hasCoords ? 'üìç GPS Location Available' : 'üìç Address Provided'}
                </span>
              </div>
              
              <div class="detail-item">
                <strong>Order Time</strong>
                <span>${orderTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} (${timeAgo})</span>
              </div>
              
              <div class="detail-item">
                <strong>Delivery Fee</strong>
                <span>‚Çπ20</span>
              </div>
            </div>
            
            ${mapLink ? `
              <a href="${mapLink}" target="_blank" class="map-link">
                üó∫Ô∏è Navigate to Customer
              </a>
            ` : ''}
            
            <div class="action-buttons">
              <button class="btn btn-primary" onclick="viewOrderDetails('${order.orderId}')">
                üëÅÔ∏è View Details
              </button>
              
              <button class="btn btn-success" onclick="acceptOrder('${order.orderId}')">
                ‚úÖ Accept Order
              </button>
              
              <button class="btn btn-danger" onclick="rejectOrder('${order.orderId}')">
                ‚ùå Reject
              </button>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    // View order details in modal
    function viewOrderDetails(orderId) {
      currentOrderId = orderId;
      
      // Fetch order details
      fetch(`${API_BASE_URL}/orders`)
        .then(res => res.json())
        .then(data => {
          const order = data.orders.find(o => o.orderId === orderId);
          if (!order) return;
          
          document.getElementById("modalTitle").textContent = `Order #${orderId}`;
          
          const modalBody = document.getElementById("modalBody");
          modalBody.innerHTML = `
            <div style="margin-bottom: 15px;">
              <strong>Order Details:</strong>
              <p>Amount: ‚Çπ${order.amount}</p>
              <p>Payment: ${order.paymentMethod}</p>
              <p>Status: ${order.status}</p>
              <p>Order Time: ${new Date(order.createdAt).toLocaleString()}</p>
            </div>
            
            <div style="margin-bottom: 15px;">
              <strong>Customer Location:</strong>
              <p>${order.location}</p>
            </div>
            
            ${order.mapLink ? `
              <a href="${order.mapLink}" target="_blank" class="map-link">
                üó∫Ô∏è Open in Google Maps
              </a>
            ` : ''}
            
            <div style="margin-top: 20px; padding: 15px; background: #f0f8ff; border-radius: 8px;">
              <strong>üí° Delivery Instructions:</strong>
              <p>1. Navigate to customer location</p>
              <p>2. Collect payment if COD</p>
              <p>3. Confirm delivery completion</p>
              <p>4. Mark as delivered</p>
            </div>
          `;
          
          document.getElementById("orderModal").style.display = "flex";
        });
    }
    
    // Accept order for delivery
    function acceptOrder(orderId) {
      if (confirm(`Accept Order #${orderId} for delivery?`)) {
        alert(`‚úÖ Order #${orderId} accepted! Navigate to customer location.`);
        // In real app, update order status in backend
        loadDeliveryOrders();
      }
    }
    
    // Reject order
    function rejectOrder(orderId) {
      const reason = prompt(`Reason for rejecting order #${orderId}?`);
      if (reason) {
        alert(`Order #${orderId} rejected: ${reason}`);
        loadDeliveryOrders();
      }
    }
    
    // Start delivery
    function startDelivery() {
      if (currentOrderId) {
        alert(`üöö Starting delivery for Order #${currentOrderId}`);
        closeModal();
        // In real app, update status to "OUT_FOR_DELIVERY"
      }
    }
    
    // Close modal
    function closeModal() {
      document.getElementById("orderModal").style.display = "none";
      currentOrderId = null;
    }
    
    // Utility: Calculate time ago
    function getTimeAgo(date) {
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      
      if (diffMins < 1) return "Just now";
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHours < 24) return `${diffHours}h ago`;
      return `${Math.floor(diffHours / 24)}d ago`;
    }
    
    // Handle clicks outside modal
    window.onclick = function(event) {
      const modal = document.getElementById("orderModal");
      if (event.target === modal) {
        closeModal();
      }
    };
    
    // Test notification function
    function testDeliveryNotification() {
        if (window.NotificationSystem) {
            NotificationSystem.playSound();
            NotificationSystem.show('TEST_' + Date.now().toString().slice(-6), 'delivery');
        } else {
            alert('Notification system not loaded. Check js/notification.js file.');
        }
    }
  </script>
</body>
</html>